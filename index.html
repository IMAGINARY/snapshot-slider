<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Swiper demo</title>
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="node_modules/swiper/dist/css/swiper.min.css">
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="main.css">
    <script src="config.js"></script>
    <script src="smtp_config.js"></script>

    <!-- load some node.js packages -->
    <script>
        window.$ = window.jQuery = require("jquery");
        require("swiper");
        window.qrImage = require("qr-image");

        window.nodemailer = require('nodemailer');
        window.htmlToText = require('html-to-text');
        window.format = require('string-template');

        require("pdfjs-dist");
        window.PDFJS.workerSrc = 'node_modules/pdfjs-dist/build/pdf.worker.js';

        // create reusable transporter object using the default SMTP transport
        window.transporter = nodemailer.createTransport(smtpConfig);

        // verify connection configuration
        transporter.verify(function(error, success) {
            if (error) {
                console.log(error);
            } else {
                console.log('Server is ready to take our messages');
            }
        });

        window.path = require('path');
        window.childProcess = require('child_process');
    </script>
</head>

<body class="noselect">

    <div id="progress">
        PDF documents loaded: <span id="progressDocs">0</span>
        <br /> PDF pages loaded: <span id="progressPages">0</span>
        <br /> PDF pages rendered: <span id="progressRendered">0</span>
    </div>

    <!-- Swiper -->
    <div class="swiper-container swiper-container-h" id="slider">
        <div class="swiper-wrapper">
        </div>
    </div>

    <div id="sendEmail">
        Send E-Mail
        <a href="javascript:switchToSlider()">Hide</a>
        <a id="mailButton" href="">Mail</a>
        <p>
            Name:
            <input id="recipientName" width="100" />
        </p>
        <p>
            Address:
            <input id="recipientAddress" width="100" />
        </p>
    </div>

    <script>
        var swiper;
        var nestedSwipers = [];

        function fileExists(filePath) {
            try {
                return fs.statSync(filePath).isFile();
            } catch (err) {
                return false;
            }
        }

        function initCache() {
            for (var i = 0; i < config.length; ++i) {
                var c = config[i];
                var basename = path.basename(c.pdfUrl, ".pdf");
                if (typeof c.isOverview == 'undefined' || c.isOverview == false) {
                    c.cachedPdf = "content/" + basename + ".pdf";
                    c.cached2on1Pdf = "content/" + basename + "-2on1.pdf";
                    c.cachedBookletPdf = "content/" + basename + "-booklet.pdf";
                    if (!fileExists(c.cachedPdf)) {
                        console.log(childProcess.execSync('2>&1 ./cache.sh ' + c.pdfUrl, {
                            encoding: 'utf-8'
                        }));
                    }
                } else {
                    c.cachedPdf = c.pdfUrl;
                }
            }
        }

        function initSliders() {
            var lastActiveIndex = -1;
            var triggerAgain;
            var callback = function() {
                if (lastActiveIndex != swiper.activeIndex) {
                    lastActiveIndex = swiper.activeIndex;
                    var start;
                    if (swiper.previousIndex < swiper.activeIndex) {
                        start = swiper.activeIndex + 3 - nestedSwipers.length;
                    } else {
                        start = swiper.activeIndex - 3;
                    }
                    start = (swiper.slides.length + start) % swiper.slides.length;
                    for (var i = start; i < start + nestedSwipers.length; ++i) {
                        $(nestedSwipers[i % nestedSwipers.length].container[0]).prependTo(swiper.slides[i]);
                    }
                }
                if (triggerAgain)
                    window.requestAnimationFrame(callback);
            }

            var swiperConfig = {
                direction: 'horizontal',
                slidesPerView: 'auto',
                freeMode: true,
                //mousewheelControl: true,
                //mousewheelForceToAxis: true,
                spaceBetween: 78,
                initialSlide: 0,
                loop: true,
                loopedSlides: config.length,
                freeModeSticky: true,
                centeredSlides: true,
                onSlideChangeStart: function(swiper) {
                    triggerAgain = true;
                    window.requestAnimationFrame(callback);
                },
                onSlideChangeEnd: function(swiper) {
                    triggerAgain = true;
                },
            };
            swiper = new Swiper('#slider', swiperConfig);

            var nestedSwiperConfig = {
                direction: 'vertical',
                slidesPerView: 'auto',
                spaceBetween: 0,
                freeMode: true,
                mousewheelControl: true,
                mousewheelForceToAxis: true,
                controlBy: 'container'
            };
            $(swiper.slides).not('.swiper-slide-duplicate').find('.swiper-container').each(function() {
                nestedSwipers.push(new Swiper(this, nestedSwiperConfig));
            });
            $(swiper.slides).filter('.swiper-slide-duplicate').find('.swiper-container').remove();
        }

        var documents = new Array(config.length);

        function initDocuments() {
            var promises = [];
            for (var i = 0; i < config.length; ++i) {
                const local_i = i;
                var promise = PDFJS.getDocument(config[local_i].cachedPdf).promise;
                promise.then(function(pdf) {
                    documents[local_i] = pdf;
                    $('#progressDocs').html(parseInt($('#progressDocs').html(), 10) + 1);
                });
                promises.push(promise);
            }
            var result = Promise.all(promises);
            result.then(function() {
                $('#progressDocs').html($('#progressDocs').html() + '. done');
            });
            return result;
        }

        function initSlides() {

            var pagePromises = [];
            var renderPromises = [];

            for (var i = 0; i < config.length; ++i) {
                const slide = document.createElement("DIV");
                slide.classList.add("swiper-slide");
                slide.classList.add("swiper-slide-h");
                $("#slider").children(".swiper-wrapper").first().append(slide);

                const verticalSwiper = $('<div class="swiper-container swiper-container-v"><div class="swiper-wrapper"></div></div>');
                const verticalSwiperWrapper = verticalSwiper.children(".swiper-wrapper").first();

                $(slide).append(verticalSwiper);
                $(slide).append(
                    `
                    <div id="button-bar-${i}" class="button-bar">
                        <a href="javascript:switchToMailMode(${i});"><i class="fa fa-envelope-o fa-3x" aria-hidden="true"></i></a>
                        <a href="javascript:print(${i});"><i class="fa fa-print fa-3x" aria-hidden="true"></i></a>
                    </div>
                `
                );

                // add QR code
                var svgObject = $(qrImage.imageSync(config[i].shortWebsiteUrl, {
                    type: 'svg',
                    size: 2
                }));
                svgObject.addClass("qrcode");
                $(`#button-bar-${i}`).append(svgObject);
                if (typeof config[i].isOverview != 'undefined' && config[i].isOverview == true)
                    $(`#button-bar-${i}`).hide();

                const pdf = documents[i];

                const div = document.createElement("div");
                div.classList.add("swiper-slide");
                div.classList.add("swiper-slide-v");
                div.style.height = 0;
                verticalSwiperWrapper.append(div);

                for (var pageNum = 1; pageNum <= pdf.numPages; ++pageNum) {
                    const div = document.createElement("div");
                    div.classList.add("swiper-slide");
                    div.classList.add("swiper-slide-v");
                    const canvas = document.createElement("CANVAS");

                    //canvas.style.border = '5px solid red';
                    canvas.width = $(slide).width();
                    div.appendChild(canvas);

                    const thisPageNum = pageNum;

                    verticalSwiperWrapper.append(div);

                    var pagePromise = pdf.getPage(pageNum).then(function(page) {
                        $('#progressPages').html(parseInt($('#progressPages').html(), 10) + 1);

                        var viewport = page.getViewport(1);
                        var scale = canvas.width / viewport.width;
                        var scaledViewport = page.getViewport(scale);
                        canvas.height = scaledViewport.height;

                        var context = canvas.getContext('2d');
                        var renderContext = {
                            canvasContext: context,
                            viewport: scaledViewport
                        };

                        var renderPromise = page.render(renderContext).then(function() {
                            $(canvas).replaceWith($('<img>').attr('src', canvas.toDataURL()));
                            $('#progressRendered').html(parseInt($('#progressRendered').html(), 10) + 1);
                        });
                        renderPromises.push(renderPromise);
                    });
                    pagePromises.push(pagePromise);
                }
            }

            return new Promise(function(resolve, reject) {
                Promise.all(pagePromises).then(function() {
                    $('#progressPages').html($('#progressPages').html() + '. done');
                    Promise.all(renderPromises).then(function() {
                        $('#progressRendered').html($('#progressRendered').html() + '. done');
                    }).then(resolve, reject);
                }, reject);
            });
        }


        function switchToSlider() {
            $('body > div').hide().filter('#slider').show();
        }

        function switchToViewer(which) {
            console.log(config);
            $('body > div').hide().filter('#showPdf').show();
        }

        function switchToMailMode(which) {
            console.log("called");
            $('#slider').css('-webkit-filter', 'blur(25px)');
            $('#sendEmail').show();
            //$('body > div').hide().filter('#sendEmail').show();
        }

        function switchToPrintMode(which) {
            $('#printButton').attr('href', 'javascript:print(' + which + ')');
            $('body > div').hide().filter('#printPdf').show();
        }

        function print(which) {
            console.log('printing ' + config[which].cachedBookletPdf);
            console.log(childProcess.execSync('lp -o landscape -o media=a4 -o sides=two-sided-short-edge ' + config[which].cachedBookletPdf, {
                encoding: 'utf-8'
            }));
        }

        function email(which) {
            var c = config[which];

            const recipientName = document.getElementById('recipientName').value;
            const recipientAddress = document.getElementById('recipientAddress').value;

            console.log('mailing ' + c.websiteUrl + ' to ' + recipientAddress);
            console.log(smtpConfig);

            const substUrls = function(s) {
                return format(s, {
                    websiteUrl: c.websiteUrl,
                    pdfUrl: c.pdfUrl,
                    defaultRecipientName: recipientName != '' ? recipientName : mailConfig.defaultRecipientName
                });
            };

            var formattedHtml = substUrls(mailConfig.html);
            var formattedText = typeof mailConfig.text != 'undefined' ? substUrls(mailConfig.text) : htmlToText.fromString(formattedHtml, {
                hideLinkHrefIfSameAsText: true
            });

            // setup e-mail data with unicode symbols
            var mailOptions = {
                from: {
                    name: mailConfig.senderName,
                    address: mailConfig.senderAddress
                }, // sender address
                to: recipientName == '' ? recipientAddress : {
                    name: recipientName,
                    address: recipientAddress
                }, // list of receivers
                subject: mailConfig.subject, // subject line
                text: formattedText, // plaintext body
                html: formattedHtml, // html body
            };

            // send mail with defined transport object
            transporter.sendMail(mailOptions, function(error, info) {
                if (error) {
                    return console.log(error);
                }
                console.log('Message sent: ' + info.response);
            });
        }

        $(document).ready(function() {
            initCache();
            initDocuments().then(function() {
                initSlides().then(function() {
                    $('#progress').hide();
                    initSliders();
                    switchToSlider();
                });
            });
        });
    </script>
</body>

</html>
