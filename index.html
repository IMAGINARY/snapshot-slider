<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Swiper demo</title>
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="node_modules/swiper/dist/css/swiper.min.css">
    <link rel="stylesheet" href="main.css">
    <script src="config.js"></script>
    <script src="smtp_config.js"></script>

    <!-- load some node.js packages -->
    <script>
        window.$ = window.jQuery = require("jquery");
        require("swiper");
        window.PdfViewer = require("pdfviewer");

        window.nodemailer = require('nodemailer');
        window.htmlToText = require('html-to-text');
        window.format = require('string-template');

        // create reusable transporter object using the default SMTP transport
        window.transporter = nodemailer.createTransport(smtpConfig);

        // verify connection configuration
        transporter.verify(function(error, success) {
            if (error) {
                console.log(error);
            } else {
                console.log('Server is ready to take our messages');
            }
        });
    </script>
    <!-- load qrcode.js -->
    <script src="node_modules/qrcode-js-package/qrcode.min.js"></script>
</head>

<body>

    <!-- Swiper -->
    <div class="swiper-container" id="slider">
        <div class="swiper-wrapper">
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
    </div>

    <!-- load slide contents from config -->
    <script>
        function initSlides() {
            var swiper_wrapper = document.getElementsByClassName("swiper-wrapper")[0];
            for (var i = 0; i < config.length; ++i) {
                var slide = document.createElement("DIV");
                slide.classList.add("swiper-slide");
                slide.innerHTML = "Slide " + i + ":<br>";
                slide.innerHTML += "<a href=\"javascript:switchToViewer( " + i + " )\">Show</a><br>";
                slide.innerHTML += "<a href=\"javascript:switchToMailMode( " + i + " )\">Mail</a><br>";
                slide.innerHTML += "<a href=\"javascript:switchToPrintMode( " + i + " )\">Print</a>";
                slide.innerHTML += "<div id=\"qrcode" + i + "\"></div>";
                swiper_wrapper.appendChild(slide);
                new QRCode(
                    "qrcode" + i, {
                        text: config[i].shortWebsiteUrl,
                        useSVG: true
                    }
                );
            }
        }
    </script>

    <div id="showPdf">
        Show PDF
        <a href="javascript:switchToSlider()">Hide</a>
        <div id="pdfViewer"></div>
    </div>

    <div id="printPdf">
        Print PDF
        <a href="javascript:switchToSlider()">Hide</a>
        <a id="printButton" href="">Print</a>
    </div>

    <div id="sendEmail">
        Send E-Mail
        <a href="javascript:switchToSlider()">Hide</a>
        <a id="mailButton" href="">Mail</a>
        <p>
            Name:
            <input id="recipientName" width="100" />
        </p>
        <p>
            Address:
            <input id="recipientAddress" width="100" />
        </p>
    </div>

    <script>
        function initSlider() {
            var swiper = new Swiper('.swiper-container', {
                loop: true,
                pagination: '.swiper-pagination',
                nextButton: '.swiper-button-next',
                prevButton: '.swiper-button-prev',
                paginationClickable: true,
                spaceBetween: 30,
            });
        }

        var path = require('path');
        var childProcess = require('child_process');

        function fileExists(filePath) {
            try {
                return fs.statSync(filePath).isFile();
            } catch (err) {
                return false;
            }
        }

        function initCache() {
            for (var i = 0; i < config.length; ++i) {
                var c = config[i];
                var basename = path.basename(c.pdfUrl, ".pdf");
                c.cachedPdf = "content/" + basename + ".pdf";
                c.cached2on1Pdf = "content/" + basename + "-2on1.pdf";
                c.cachedBookletPdf = "content/" + basename + "-booklet.pdf";
                if (!fileExists(c.cachedPdf)) {
                    console.log(childProcess.execSync('2>&1 ./cache.sh ' + c.pdfUrl, {
                        encoding: 'utf-8'
                    }));
                }
            }
        }

        function switchToSlider() {
            $('body > div').hide().filter('#slider').show();
        }

        function switchToViewer(which) {
            console.log(config);
            $('body > div').hide().filter('#showPdf').show();
            new PdfViewer({
                pdfUrl: path.resolve(config[which].cached2on1Pdf),
                staticHost: 'node_modules/pdfviewer/dist/index.html',
                onerror: function(err) {
                    console.error('PdfViewer', err);
                }
            }).embed(document.getElementById('pdfViewer'));
        }

        function switchToMailMode(which) {
            $('#mailButton').attr('href', 'javascript:email(' + which + ')');
            $('body > div').hide().filter('#sendEmail').show();
        }

        function switchToPrintMode(which) {
            $('#printButton').attr('href', 'javascript:print(' + which + ')');
            $('body > div').hide().filter('#printPdf').show();
        }

        function print(which) {
            console.log('printing ' + config[which].cachedBookletPdf);
            console.log(childProcess.execSync('lp -o landscape -o media=a4 -o sides=two-sided-short-edge ' + config[which].cachedBookletPdf, {
                encoding: 'utf-8'
            }));
        }

        function email(which) {
            var c = config[which];

            const recipientName = document.getElementById('recipientName').value;
            const recipientAddress = document.getElementById('recipientAddress').value;

            console.log('mailing ' + c.websiteUrl + ' to ' + recipientAddress);
            console.log(smtpConfig);

            const substUrls = function(s) {
                return format(s, {
                    websiteUrl: c.websiteUrl,
                    pdfUrl: c.pdfUrl,
                    defaultRecipientName: recipientName != '' ? recipientName : mailConfig.defaultRecipientName
                });
            };

            var formattedHtml = substUrls(mailConfig.html);
            var formattedText = typeof mailConfig.text != 'undefined' ? substUrls(mailConfig.text) : htmlToText.fromString(formattedHtml, {
                hideLinkHrefIfSameAsText: true
            });

            // setup e-mail data with unicode symbols
            var mailOptions = {
                from: {
                    name: mailConfig.senderName,
                    address: mailConfig.senderAddress
                }, // sender address
                to: recipientName == '' ? recipientAddress : {
                    name: recipientName,
                    address: recipientAddress
                }, // list of receivers
                subject: mailConfig.subject, // subject line
                text: formattedText, // plaintext body
                html: formattedHtml, // html body
            };

            // send mail with defined transport object
            transporter.sendMail(mailOptions, function(error, info) {
                if (error) {
                    return console.log(error);
                }
                console.log('Message sent: ' + info.response);
            });
        }

        $(document).ready(function() {
            initCache();
            initSlides();
            initSlider();
            switchToSlider();
        });
    </script>
</body>

</html>
