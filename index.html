<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Swiper demo</title>
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="libs/jqbtk.min.css">
    <link rel="stylesheet" href="node_modules/swiper/dist/css/swiper.min.css">
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="main.css">
    <script src="config.js"></script>
    <script src="smtp_config.js"></script>

    <!-- load some node.js packages -->
    <script>
        window.$ = window.jQuery = require("jquery");
        require('bootstrap');
        window.bootbox = require('bootbox');
        require("swiper");
        window.qrImage = require("qr-image");

        window.nodemailer = require('nodemailer');
        window.htmlToText = require('html-to-text');
        window.format = require('string-template');

        require("pdfjs-dist");
        window.PDFJS.workerSrc = 'node_modules/pdfjs-dist/build/pdf.worker.js';

        // create reusable transporter object using the default SMTP transport
        window.transporter = nodemailer.createTransport(smtpConfig);

        // verify connection configuration
        transporter.verify(function(error, success) {
            if (error) {
                console.log(error);
            } else {
                console.log('Server is ready to take our messages');
            }
        });

        window.path = require('path');
        window.childProcess = require('child_process');
    </script>
    <script src="libs/jqbtk.js"></script>
</head>

<body class="noselect">

    <div id="progress">
        PDF documents cached: <span id="progressCache">0</span>
        <br />PDF documents loaded: <span id="progressDocs">0</span>
        <br /> PDF pages loaded: <span id="progressPages">0</span>
        <br /> PDF pages rendered: <span id="progressRendered">0</span>
    </div>

    <!-- Swiper -->
    <div class="swiper-container swiper-container-h" id="slider">
        <div class="swiper-wrapper">
        </div>
    </div>

    <div id="sendEmail">
        Send E-Mail
        <a href="javascript:switchToSlider()">Hide</a>
        <a id="mailButton" href="">Mail</a>
        <p>
            Name:
            <input id="recipientName" width="100" />
        </p>
        <p>
            Address:
            <input id="recipientAddress" width="100" />
        </p>
    </div>

    <script>
        var swiper;
        var swiperInitialSlide;
        var nestedSwipers = [];

        function rearrangeConfig() {
            // reverse order such that oldest items come first
            config.reverse();

            // put overview page to the beginning again
            var overviewElem = config.pop();
            config.unshift(overviewElem);

            // move ~half of the slides from the end to the beginning
            for (swiperInitialSlide = 0; swiperInitialSlide < Math.floor(config.length / 2); ++swiperInitialSlide) {
                var elem = config.pop();
                config.unshift(elem);
            }
        }

        function fileExists(filePath) {
            try {
                return fs.statSync(filePath).isFile();
            } catch (err) {
                return false;
            }
        }

        function initCache() {
            var promises = [];
            for (var i = 0; i < config.length; ++i) {
                const c = config[i];
                promises.push(new Promise(
                    function(resolve, reject) {
                        const resolve_wrapper = () => {
                            $('#progressCache').html(parseInt($('#progressCache').html(), 10) + 1 + ' of ' + config.length);
                            resolve();
                        }
                        var basename = path.basename(c.pdfUrl, ".pdf");
                        c.cachedPdf = "content/" + basename + ".pdf";
                        c.cached2on1Pdf = "content/" + basename + "-2on1.pdf";
                        c.cachedBookletPdf = "content/" + basename + "-booklet.pdf";
                        if (!fileExists(c.cachedPdf)) {
                            childProcess.exec('2>&1 ./cache.sh ' + c.pdfUrl, {
                                encoding: 'utf-8'
                            }, (error, stdout, stderr) => {
                                console.log(stdout);
                                if (error) {
                                    reject();
                                    throw error;
                                } else {
                                    resolve_wrapper();
                                }
                            });
                        } else {
                            resolve_wrapper();
                        }
                    }
                ));
            }
            var result = Promise.all(promises);
            result.then(function() {
                $('#progressCache').html($('#progressCache').html() + '. done');
            });
            return result;
        }

        function initSliders() {
            var lastActiveIndex = -1;
            var triggerAgain;
            var callback = function() {
                if (lastActiveIndex != swiper.activeIndex) {
                    lastActiveIndex = swiper.activeIndex;
                    var start;
                    if (swiper.previousIndex < swiper.activeIndex) {
                        start = swiper.activeIndex + 3 - nestedSwipers.length;
                    } else {
                        start = swiper.activeIndex - 3;
                    }
                    start = (swiper.slides.length + start) % swiper.slides.length;
                    for (var i = start; i < start + nestedSwipers.length; ++i) {
                        $(nestedSwipers[i % nestedSwipers.length].container[0]).prependTo(swiper.slides[i]);
                    }
                }
                if (triggerAgain)
                    window.requestAnimationFrame(callback);
            }

            var swiperConfig = {
                direction: 'horizontal',
                slidesPerView: 'auto',
                freeMode: true,
                effect: 'coverflow',
                //mousewheelControl: true,
                //mousewheelForceToAxis: true,
                spaceBetween: 78,
                initialSlide: swiperInitialSlide,
                loop: true,
                loopedSlides: config.length,
                freeModeSticky: true,
                freeModeMomentumRatio: 0.25,
                centeredSlides: true,
                onSlideChangeStart: function(swiper) {
                    triggerAgain = true;
                    window.requestAnimationFrame(callback);
                },
                onSlideChangeEnd: function(swiper) {
                    triggerAgain = true;
                },
            };
            swiper = new Swiper('#slider', swiperConfig);
            for (var i = 0; i < swiper.slides.length; i++)
                $(swiper.slides[i]).attr("data-swiper-fake-slide-index", i);

            var nestedSwiperConfig = {
                direction: 'vertical',
                slidesPerView: 'auto',
                spaceBetween: 4,
                freeMode: true,
                freeModeSticky: true,
                mousewheelControl: true,
                mousewheelForceToAxis: true,
                controlBy: 'container'
            };
            $(swiper.slides).not('.swiper-slide-duplicate').find('.swiper-container').each(function() {
                nestedSwipers.push(new Swiper(this, nestedSwiperConfig));
            });
            $(swiper.slides).filter('.swiper-slide-duplicate').find('.swiper-container').remove();
        }

        var documents = new Array(config.length);
        var totalNumPages = 0;

        function initDocuments() {
            var promises = [];
            for (var i = 0; i < config.length; ++i) {
                const local_i = i;
                var promise = PDFJS.getDocument(config[local_i].cachedPdf).promise;
                promise.then(function(pdf) {
                    documents[local_i] = pdf;
                    totalNumPages += pdf.numPages;
                    $('#progressDocs').html(parseInt($('#progressDocs').html(), 10) + 1 + ' of ' + config.length);
                });
                promises.push(promise);
            }
            var result = Promise.all(promises);
            result.then(function() {
                $('#progressDocs').html($('#progressDocs').html() + '. done');
            });
            return result;
        }

        function initSlides() {

            var pagePromises = [];
            var renderPromises = [];

            for (var i = 0; i < config.length; ++i) {
                const slide = document.createElement("DIV");
                slide.classList.add("swiper-slide");
                slide.classList.add("swiper-slide-h");
                $("#slider").children(".swiper-wrapper").first().append(slide);

                const verticalSwiper = $('<div class="swiper-container swiper-container-v"><div class="swiper-wrapper"></div></div>');
                const verticalSwiperWrapper = verticalSwiper.children(".swiper-wrapper").first();

                const isFrontPage = typeof config[i].isFrontPage != 'undefined' && config[i].isFrontPage == true;

                $(slide).append(verticalSwiper);
                const buttonBar = $(slide).append(`<div id="button-bar-${i}" class="button-bar"></div>`).children().last();
                buttonBar.append(`<a href="javascript:switchToMailMode(${i});"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>`);
                if (isFrontPage)
                    buttonBar.append(`<i class="fa fa-print disabled" aria-hidden="true"></i>`);
                else
                    buttonBar.append(`<a href="javascript:switchToPrintMode(${i});"><i class="fa fa-print" aria-hidden="true"></i></a>`);

                // add QR code
                var svgObject = $(qrImage.imageSync(config[i].shortWebsiteUrl, {
                    type: 'svg',
                    size: 2
                }));
                svgObject.addClass("qrcode");
                $(`#button-bar-${i}`).append(svgObject);
                if (isFrontPage)
                    $(`#button-bar-${i}`).addClass('overview');

                const pdf = documents[i];

                for (var pageNum = 1; pageNum <= pdf.numPages; ++pageNum) {
                    const div = document.createElement("div");
                    div.classList.add("swiper-slide");
                    div.classList.add("swiper-slide-v");
                    const canvas = document.createElement("CANVAS");

                    canvas.width = $(slide).width();
                    div.appendChild(canvas);

                    const thisPageNum = pageNum;

                    verticalSwiperWrapper.append(div);

                    var pagePromise = pdf.getPage(pageNum).then(function(page) {
                        $('#progressPages').html(parseInt($('#progressPages').html(), 10) + 1 + ' of ' + totalNumPages);

                        var viewport = page.getViewport(1);
                        var scale = canvas.width / viewport.width;
                        var scaledViewport = page.getViewport(scale);
                        canvas.height = scaledViewport.height;

//                        var context = canvas.getContext("2d", {alpha: false});
                        var context = canvas.getContext("2d");
                        var renderContext = {
                            canvasContext: context,
                            viewport: scaledViewport
                        };

                        var renderPromise = page.render(renderContext).then(function() {
                            //$(canvas).replaceWith($('<img>').attr('src', canvas.toDataURL()));
                            $('#progressRendered').html(parseInt($('#progressRendered').html(), 10) + 1 + ' of ' + totalNumPages);
                        });
                        renderPromises.push(renderPromise);
                    });
                    pagePromises.push(pagePromise);
                }
            }

            return new Promise(function(resolve, reject) {
                Promise.all(pagePromises).then(function() {
                    $('#progressPages').html($('#progressPages').html() + '. done');
                    Promise.all(renderPromises).then(function() {
                        $('#progressRendered').html($('#progressRendered').html() + '. done');
                    }).then(resolve, reject);
                }, reject);
            });
        }

        function initIdleHandlers() {
            var idle_timer = null;
            var init_idle_timer = function(delay) {
                if (idle_timer != null)
                    clearTimeout(idle_timer);
                idle_timer = setTimeout(idle_handler, delay);
            }
            var non_idle_handler = function(evt) {
                console.log("non_idle_handler");
                init_idle_timer(miscConfig.idleModeDelayMs);
            }
            var idle_handler = function() {
                console.log("idle_handler");
                idleAction();
                init_idle_timer(miscConfig.idleModeDelayBetweenActionsMs);
            }

            document.body.addEventListener('mouseup', non_idle_handler, true);
            document.body.addEventListener('mousemove', non_idle_handler, true);
            document.body.addEventListener('mousedown', non_idle_handler, true);
            document.body.addEventListener("touchstart", non_idle_handler, true);
            document.body.addEventListener("touchend", non_idle_handler, true);
            document.body.addEventListener("touchcancel", non_idle_handler, true);
            document.body.addEventListener("touchmove", non_idle_handler, true);
            document.body.addEventListener("onscroll", non_idle_handler, true);

            init_idle_timer(miscConfig.idleModeDelayMs);
        }

        function idleAction() {
            bootbox.hideAll();
            nestedSwipers[(swiper.activeIndex + 2) % config.length].slideTo(0, 0);
            swiper.slideNext(true, miscConfig.idleAnimationDurationMs);
        }

        function switchToSlider() {
            $('body > div').hide().filter('#slider').show();
        }

        function switchToViewer(which) {
            console.log(config);
            $('body > div').hide().filter('#showPdf').show();
        }

        var recipientName = '';
        var recipientAddress = '';

        function switchToMailMode(which) {
            bootbox.confirm({
                title: 'Please enter your email address',
                message: '<p>Select one of the input fields to open the on screen keyboard. Click outside the on screen keyboard to hide it.</p><br /><p><div class="form-group"><label for="emailName">Name:</label><input type="text" class="keyboard form-control" id="emailName"></div><div class="form-group"><label for="emailAddress">Email:</label><input type="text" class="keyboard form-control" id="emailAddress"></div></p>',
                callback: function(result) {
                    if (result) {
                        recipientName = $('#emailName').val().trim();
                        recipientAddress = $('#emailAddress').val().trim();
                        email(which);
                        recipientName = '';
                        recipientAddress = '';
                    }
                }
            });
            $("#emailName").keyboard();
            $("#emailAddress").keyboard();
        }

        function switchToPrintMode(which) {
            bootbox.confirm({
                title: 'Confirm printing',
                message: `<p class="dialog">Do you want to print: <em>"<b>${config[which].author.trim()}:</b> ${config[which].title.trim()}"</em>?<p>`,
                callback: function(result) {
                    if (result) {
                        print(which);
                    }
                }
            });
        }

        function print(which) {
            console.log('printing ' + config[which].cachedBookletPdf);
            console.log(childProcess.execSync('lp -o landscape -o media=a4 -o sides=two-sided-short-edge ' + config[which].cachedBookletPdf, {
                encoding: 'utf-8'
            }));
        }

        function email(which) {
            var c = config[which];

            console.log('mailing ' + c.websiteUrl + ' to ' + recipientAddress);
            console.log(smtpConfig);

            const substUrls = function(s) {
                return format(s, {
                    websiteUrl: c.websiteUrl,
                    pdfUrl: c.pdfUrl,
                    defaultRecipientName: recipientName != '' ? recipientName : mailConfig.defaultRecipientName
                });
            };

            var formattedHtml = substUrls(mailConfig.html);
            var formattedText = typeof mailConfig.text != 'undefined' ? substUrls(mailConfig.text) : htmlToText.fromString(formattedHtml, {
                hideLinkHrefIfSameAsText: true
            });

            // setup e-mail data with unicode symbols
            var mailOptions = {
                from: {
                    name: mailConfig.senderName,
                    address: mailConfig.senderAddress
                }, // sender address
                to: recipientName == '' ? recipientAddress : {
                    name: recipientName,
                    address: recipientAddress
                }, // list of receivers
                subject: mailConfig.subject, // subject line
                text: formattedText, // plaintext body
                html: formattedHtml, // html body
            };

            // send mail with defined transport object
            transporter.sendMail(mailOptions, function(error, info) {
                if (error) {
                    bootbox.alert('Email could not be sent');
                    console.log(error);
                } else {
                    bootbox.alert('Email sent successfully');
                }
            });
        }

        $(document).ready(function() {
            rearrangeConfig();
            initCache().then(function() {
                initDocuments().then(function() {
                    initSlides().then(function() {
                        $('#progress').hide();
                        initSliders();
                        initIdleHandlers();
                        switchToSlider();
                    });
                });
            });
        });
    </script>
</body>

</html>
