<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>SNAPSHOT slider</title>
    <base href="../../">
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="node_modules/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css">
    <link rel="stylesheet" href="libs/jqbtk.min.css">
    <link rel="stylesheet" href="node_modules/swiper/dist/css/swiper.min.css">
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="node_modules/animate.css/animate.min.css">
    <link rel="stylesheet" href="main.css">

    <!-- load some node.js packages -->
    <script>
        remote = require('electron').remote;
        var _ = require('lodash');
        var Promise = require("bluebird");
        window.path = require('path');
        var packageJson = require(path.join(remote.app.getAppPath(),'package.json'));
        var semver = require('semver');
        window.validateJSON = require('jsonschema').validate;
        window.settings = require('electron-settings');
        var miscConfig = settings.getAll();
        var articles = _.cloneDeep(miscConfig.snapshots.articles);
        var snapshots; // to be initialized after rearrangement of SNAPSHOT list
        var mailConfig = miscConfig.mail;
        if (typeof mailConfig.text !== "undefined" && mailConfig.text !== null)
            mailConfig.text = mailConfig.text.join("\n");
        if (typeof mailConfig.html !== "undefined" && mailConfig.html !== null)
            mailConfig.html = mailConfig.html.join("\n");

        // TODO: complete migration to jQuery v3 depends on bootbox support
        window.$ = window.jQuery = require("jquery-migrate");
        window.jQuery.migrateTrace = false;

        require('bootstrap');
        require('bootstrap-notify');
        window.bootbox = require('bootbox');
        window.Swiper = require("swiper");
        window.qrImage = require("qr-image");

        window.nodemailer = require('nodemailer');
        window.htmlToText = require('html-to-text');
        window.format = require('string-template');

        // create reusable transporter object using the default SMTP transport
        window.transporter = nodemailer.createTransport(mailConfig.smtp);

        // verify connection configuration
        transporter.verify(function(error, success) {
            if (error) {
                console.log(error);
            } else {
                console.log('Server is ready to take our messages');
            }
        });

        window.fs = require('fs');
        window.fsExtra = require('fs-extra');

        const userDataDir = remote.app.getPath("userData");
        const cacheDir = path.join(path.dirname(require('cachedir')('dummy')),remote.app.getName());
        fsExtra.mkdirpSync(cacheDir);
        console.log(cacheDir);
        const pdfCacheDirname = path.join(cacheDir, "pdf");
        const pngCacheDirname = path.join(cacheDir, "png");
        {
            // migrate old caches of PDF and PNG files to new location
            const oldPdfCacheDirname = path.join(userDataDir, "pdfCache");
            if(!fs.existsSync(pdfCacheDirname) && fs.existsSync(oldPdfCacheDirname))
                fs.renameSync(oldPdfCacheDirname,pdfCacheDirname);
            const oldPngCacheDirname = path.join(userDataDir, "pngCache");
            if(!fs.existsSync(pngCacheDirname) && fs.existsSync(oldPngCacheDirname))
                fs.renameSync(oldPngCacheDirname,pngCacheDirname);
        }
        fsExtra.mkdirpSync(pdfCacheDirname);
        fsExtra.mkdirpSync(pngCacheDirname);

        function fromBaseDir(modulePath) {
            return path.join(remote.app.getAppPath(), modulePath);
        }

        const SNAPSHOT = require(fromBaseDir('src/js/renderer/SNAPSHOT.js'));
        const SnapshotPrinter = require(fromBaseDir('src/js/renderer/SnapshotPrinter.js'));
    </script>
    <script src="libs/jqbtk.js"></script>
</head>

<body class="noselect">

    <div id="full-hd-centered">
        <!-- Swiper -->
        <div class="swiper-container swiper-container-h" id="slider">
            <div class="swiper-wrapper">
            </div>
        </div>
    </div>

    <template id="progressTemplate">
        <div class="progress">
            <span class="progressbar-back-text"></span>
            <div id="progressCache" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" style="width:0%;" template="{0} of {1} documents cached">
                <span class="progressbar-front-text"></span>
            </div>
        </div>
        <div class="progress">
            <span class="progressbar-back-text"></span>
            <div id="progressDocs" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" style="width:0%" template="{0} of {1} documents initialized">
                <span class="progressbar-front-text"></span>
            </div>
        </div>
        <div class="progress">
            <span class="progressbar-back-text"></span>
            <div id="progressPages" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" style="width:0%" template="{0} of {1} pages loaded">
                <span class="progressbar-front-text"></span>
            </div>
        </div>
        <div class="progress">
            <span class="progressbar-back-text"></span>
            <div id="progressRendered" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" style="width:0%" template="{0} of {1} pages cached">
                <span class="progressbar-front-text"></span>
            </div>
        </div>
    </template>
    <script>
        var initNotification;

        function initInitNotification() {
            return new Promise((resolve, reject) => {
                    initNotification = $.notify({
                        icon: "fa fa-circle-o-notch fa-spin fa-fw",
                        title: "Initializing …",
                        message: '<div id="progress"></div>'
                    }, {
                        placement: {
                            from: "bottom",
                            align: "right"
                        },
                        animate: {
                            enter: 'animated fadeInRight',
                            exit: 'animated fadeOutRight'
                        },
                        delay: 0,
                        onShow: resolve,
                        allow_dismiss: false
                    })
                })
                .then(() => $("#progress").append($("#progressTemplate")[0].content.children))
                .then(() => ["#progressCache", "#progressDocs", "#progressPages", "#progressRendered"].forEach(e => updateProgressBar(e)));
        }

        function updateProgressBar(progressBar, data) {
            $progressBar = $(progressBar);

            if (typeof data === "object" || typeof data === "function") {
                ["min", "max", "now"].forEach((e, i, a) => {
                    if (data.hasOwnProperty(e)) {
                        if (data.offset === true)
                            increaseAttr($progressBar, `aria-value${e}`, data[e]);
                        else
                            $progressBar.attr(`aria-value${e}`, data[e]);
                    }
                });
            }

            var min = $progressBar.attr("aria-valuemin");
            var max = $progressBar.attr("aria-valuemax");
            var now = $progressBar.attr("aria-valuenow");
            var percentage = 100 * (now - min) / (max - min);
            $progressBar.css("width", `${percentage}%`);

            $frontText = $progressBar.find(".progressbar-front-text");
            $frontText.css("width", $progressBar.parent().css("width"));
            $frontText.text(format($progressBar.attr("template"), now, max));
            $backText = $progressBar.parent().find(".progressbar-back-text");
            $backText.text(format($progressBar.attr("template"), now, max));
        }

        function increaseAttr(selector, attr, amount) {
            $(selector).attr(attr, parseInt($(selector).attr(attr), 10) + amount);
        }

        var _openNotifications = {};
        function _notify(icon, title, message, details, type) {
            this.id = typeof this.id === "undefined" ? this.id = 0 : this.id + 1;
            var currId = this.id;

            console.log({
                id: this.id,
                type: type,
                title: title,
                message: message,
                details: details
            });

            var detailsHTML = ""
            if (!(typeof details === "undefined")) {
                if (details instanceof Error)
                    details = details.stack;
                else if (details instanceof Object)
                    details = JSON.stringify(details, null, 2);

                detailsHTML =
                    `
                    <i class="fa fa-caret-down" aria-hidden="true" onClick="$('#collapsibleDetails${currId}').on('shown.bs.collapse',()=>_openNotifications[${currId}].update({}));$('#collapsibleDetails${currId}').collapse('show');$(this).css('display','none');$(this).next().css('display','');"></i>
                    <i class="fa fa-caret-up" aria-hidden="true" style="display: none;" onClick="$('#collapsibleDetails${currId}').on('hidden.bs.collapse',()=>_openNotifications[${currId}].update({}));$('#collapsibleDetails${currId}').collapse('hide');$(this).css('display','none');$(this).prev().css('display','');"></i>
                    <div id="collapsibleDetails${currId}" class="collapse">
                        <pre class="notifyDetails">${details}</pre>
                    </div>
                `;
            }

            return new Promise((resolve, reject) => _openNotifications[currId] = $.notify({
                icon: icon,
                title: title,
                message: typeof message === 'undefined' ? "" : message + detailsHTML
            }, {
                type: type,
                placement: {
                    from: "bottom",
                    align: "right"
                },
                animate: {
                    enter: 'animated fadeInRight',
                    exit: 'animated fadeOutRight'
                },
                onClosed: () => {
                    delete _openNotifications[currId];
                    resolve();
                },
                delay: 4000,
                mouse_over: 'pause'
            }));
        }

        var notifySuccess = (title, message, details) => _notify("fa fa-check-square", title, message, details, "success");
        var notifyInfo = (title, message, details) => _notify("fa fa-info-circle", title, message, details, "info");
        var notifyWarning = (title, message, details) => _notify("fa fa-exclamation-triangle", title, message, details, "warning");
        var notifyError = (title, message, details) => _notify("fa fa-exclamation-circle", title, message, details, "danger");
    </script>

    <script>
        var swiper;
        var swiperInitialSlide;
        var nestedSwipers = [];

        if (miscConfig.hideCursor) {
            var lastCSS = document.styleSheets[document.styleSheets.length - 1];
            lastCSS.insertRule("* { cursor: none; }", lastCSS.cssRules.length);
        }

        window.onresize = e => {
            var sx = $(window).width() / 1920;
            var sy = $(window).height() / 1080;
            var s = Math.min(sx, sy);
            var fullHdCentered = document.getElementById("full-hd-centered");
            fullHdCentered.style.transform = `scale(${s})`;
            fullHdCentered.style.left = `${($(window).width()-1920*s)/2.0}px`;
            fullHdCentered.style.top = `${($(window).height()-1080*s)/2.0}px`;
        }
        window.onresize();

        document.body.ondblclick = e => {
            if (mode == "slider") {
                var win = remote.getCurrentWindow();
                var sx = win.getContentSize()[0] / 1920;
                var sy = win.getContentSize()[0] / 1080;
                var s = Math.min(sx, sy);
                win.setContentSize(Math.floor(1920 * s), Math.floor(1080 * s), true);
            }
        }
        document.body.ondblclick();

        document.onkeydown = e => {
            if (mode == "slider") {
                const actions = {
                    "i": about,
                    "ArrowLeft": () => swiper.slidePrev(), // left arrow
                    "ArrowRight": () => swiper.slideNext(), // right arrow
                    "ArrowDown": () => nestedSwipers[swiper.realIndex].slideNext(), // down arrow
                    "ArrowUp": () => nestedSwipers[swiper.realIndex].slidePrev() // up arrow
                };
                actions[miscConfig.snapshots.autoUpdate.hotkey] = switchToUpdateMode;
                if (typeof actions[e.key] !== 'undefined')
                    actions[e.key]();
            }
        };

        function about() {
            notifyInfo(
                `About ${packageJson.productName}`,
                `License: ${packageJson.license}<br/>Version: ${packageJson.version}`,
                process.versions
            );
        }

        function rearrangeConfig() {
            if (miscConfig.snapshots.sort.enable) {
                var sortConfig = miscConfig.snapshots.sort;
                if (typeof sortConfig.by !== "undefined" && sortConfig.by != null)
                    sortConfig.compareFunction = `(a,b) => a.${sortConfig.by}.localeCompare(b.${sortConfig.by})`;
                articles = articles.sort(eval(sortConfig.compareFunction));
            }

            if (miscConfig.snapshots.filter.enable)
                articles = articles.filter(eval(miscConfig.snapshots.filter.filterFunction));

            // reverse order such that oldest items come first
            articles.reverse();

            // put overview page to the beginning
            var frontPage = settings.get("snapshots.frontPage");
            frontPage.isFrontPage = true;
            articles.unshift(frontPage);

            // move ~half of the slides from the end to the beginning
            for (swiperInitialSlide = 0; swiperInitialSlide < Math.floor(articles.length / 2); ++swiperInitialSlide) {
                var elem = articles.pop();
                articles.unshift(elem);
            }
        }

        function initTopLevelSlides() {
            for (var i = 0; i < articles.length; ++i) {
                const slide = document.createElement("DIV");
                slide.classList.add("swiper-slide");
                slide.classList.add("swiper-slide-h");
                $("#slider").children(".swiper-wrapper").first().append(slide);
                const $slide_wrapper = $('<div/>', {
                    class: 'slide-wrapper'
                });
                $(slide).append($slide_wrapper);

                const verticalSwiper = $('<div class="swiper-container swiper-container-v" style="transform: translateZ(0);"><div class="swiper-wrapper"></div></div>');

                const isFrontPage = typeof articles[i].isFrontPage != 'undefined' && articles[i].isFrontPage == true;

                $slide_wrapper.append(verticalSwiper);
                const buttonBar = $slide_wrapper.append(`<div id="button-bar-${i}" class="button-bar"></div>`).children().last();

                if (!miscConfig.mail.enable)
                    buttonBar.append(`<i class="fa fa-envelope-o disabled" aria-hidden="true"></i>`);
                else
                    buttonBar.append(`<a href="javascript:switchToMailMode(${i});"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>`);

                if (isFrontPage || !miscConfig.print.enable)
                    buttonBar.append(`<i class="fa fa-print disabled" aria-hidden="true"></i>`);
                else
                    buttonBar.append(`<a href="javascript:switchToPrintMode(snapshots[${i}]);"><i class="fa fa-print" aria-hidden="true"></i></a>`);

                // add QR code
                var svgObject = $(qrImage.imageSync(articles[i].url_short, {
                    type: 'svg',
                    size: 2
                }));
                svgObject.addClass("qrcode");
                $(`#button-bar-${i}`).append(svgObject);
                if (isFrontPage)
                    $(`#button-bar-${i}`).addClass('overview');
            }
        }

        async function initNestedSlides(nestedSwiper, snapshot) {
            nestedSwiper.update(true);
            const numPages = (await snapshot.initDocumentPromise).numPages;
            const promises = new Array(numPages);
            for (var pageNum = 0; pageNum < numPages; ++pageNum) {
                const loader = document.createElement("div");
                loader.classList.add("loader");
                const image = document.createElement("img");
                promises[pageNum] = snapshot
                    .getPageRenderingPath(pageNum, nestedSwiper.width, nestedSwiper.height)
                    .then(path => image.src = path)
                    .then(() => loader.remove());
                const div = document.createElement("div");
                div.appendChild(image);
                div.appendChild(loader);
                div.classList.add("swiper-slide");
                div.classList.add("swiper-slide-v");

                nestedSwiper.appendSlide(div);
            }
            nestedSwiper.update(true);
            await Promise.all(promises);
        }

        var initComplete = false;

        function initSliders() {
            var lastActiveIndex = -1;
            var triggerAgain = false;
            var callback = function() {
                if (lastActiveIndex != swiper.activeIndex && initComplete) {
                    const rearrangement = {};
                    for (var i = swiper.activeIndex - 5; i <= swiper.activeIndex + 5; i++) {
                        const slide = swiper.slides[i];
                        if(typeof slide === 'undefined')
                            continue; // index out of range -> skip this one

                        const tlSlideIndex = slide.getAttribute("data-swiper-slide-index");
                        const nestedSwiper = nestedSwipers[tlSlideIndex].el;

                        slide.querySelector(".slide-wrapper").appendChild(nestedSwiper);
                        rearrangement[tlSlideIndex] = i;
                    }
                    console.log("reassigned slides:", rearrangement);

                    lastActiveIndex = swiper.activeIndex;
                }
                if (triggerAgain)
                    window.requestAnimationFrame(callback);
            }

            var swiperConfig = {
                direction: 'horizontal',
                slidesPerView: 3,
                freeMode: true,
                effect: 'coverflow',
                //mousewheelControl: true,
                //mousewheelForceToAxis: true,
                spaceBetween: 78,
                initialSlide: swiperInitialSlide,
                loop: true,
                loopedSlides: articles.length,
                freeModeSticky: true,
                freeModeMomentumRatio: 0.25,
                centeredSlides: true,
                slideReassignCallback: callback,
                on: {
                    slideChangeTransitionStart: function(swiper) {
                        triggerAgain = true;
                        window.requestAnimationFrame(callback);
                    },
                    slideChangeTransitionEnd: function(swiper) {
                        triggerAgain = false;
                    },
                    transitionStart: function(swiper) {
                        triggerAgain = true;
                        window.requestAnimationFrame(callback);
                    },
                    transitionEnd: function(swiper) {
                        triggerAgain = false;
                    },
                    sliderMove: function(swiper) {
                        window.requestAnimationFrame(callback);
                    },
                }

            };
            swiper = new Swiper('#slider', swiperConfig);
            for (var i = 0; i < swiper.slides.length; i++)
                $(swiper.slides[i]).attr("data-swiper-fake-slide-index", i);

            var nestedSwiperConfig = {
                direction: 'vertical',
                slidesPerView: 1,
                spaceBetween: 4,
                freeMode: true,
                freeModeSticky: true,
                mousewheelControl: true,
                mousewheelForceToAxis: true,
                controlBy: 'container'
            };
            $(swiper.slides).not('.swiper-slide-duplicate').find('.swiper-container').each(function() {
                nestedSwipers.push(new Swiper(this, nestedSwiperConfig));
            });
            $(swiper.slides).filter('.swiper-slide-duplicate').find('.swiper-container').remove();
        }

        function disableSnapshot(index) {
            // disable mail and print buttons
            $(`#button-bar-${index} a > i`).unwrap();
            $(`#button-bar-${index} i`).addClass("disabled");
        }

        function initIdleHandlers() {
            var idle_timer = null;
            var init_idle_timer = function(delay) {
                if (idle_timer != null)
                    clearTimeout(idle_timer);
                idle_timer = setTimeout(idle_handler, delay);
            }
            var non_idle_handler = function(evt) {
                console.log("non_idle_handler");
                init_idle_timer(miscConfig.idleModeDelayMs);
            }
            var idle_handler = function() {
                console.log("idle_handler");
                idleAction();
                init_idle_timer(miscConfig.idleModeDelayBetweenActionsMs);
            }

            document.body.addEventListener('mouseup', non_idle_handler, true);
            document.body.addEventListener('mousemove', non_idle_handler, true);
            document.body.addEventListener('mousedown', non_idle_handler, true);
            document.body.addEventListener("touchstart", non_idle_handler, true);
            document.body.addEventListener("touchend", non_idle_handler, true);
            document.body.addEventListener("touchcancel", non_idle_handler, true);
            document.body.addEventListener("touchmove", non_idle_handler, true);
            document.body.addEventListener("onscroll", non_idle_handler, true);
            document.body.addEventListener("keydown", non_idle_handler, true);
            document.body.addEventListener("keyup", non_idle_handler, true);
            document.body.addEventListener("keypress", non_idle_handler, true);

            init_idle_timer(miscConfig.idleModeDelayMs);
        }

        function idleAction() {
            bootbox.hideAll();
            nestedSwipers[(swiper.activeIndex + 2) % articles.length].slideTo(0, 0);
            swiper.slideNext(miscConfig.idleAnimationDurationMs,true);
        }

        var mode;

        function switchToSlider() {
            mode = "slider";
            $('#slider').show();
        }

        function switchToUpdateMode() {
            mode = "update";

            bootbox.confirm({
                title: 'Confirm update',
                message: '<p class="dialog">Are you sure that you want to update the list of available SNAPSHOTS?<p>',
                callback: function(result) {
                    if (result)
                        updateSnapshotList();
                    switchToSlider();
                }
            });
        }

        function updateSnapshotList() {
            var errorNotificationTitle = "Update of SNAPSHOT list failed";
            var successNotificationTitle = "Update of SNAPSHOT list successful";

            return new Promise((resolve, reject) => {
                request.get({
                    url: miscConfig.snapshots.autoUpdate.url,
                }, (err, res, body) => {
                    if (err) {
                        notifyError(errorNotificationTitle, "The list could not be downloaded.", err);
                        reject(err);
                    } else if (res.statusCode !== 200) {
                        notifyError(errorNotificationTitle, "The list could not be downloaded.", `Unexpected HTTP status code${res.statusCode}`);
                        reject(res.statusCode);
                    } else {
                        try {
                            var json = JSON.parse(body);

                            var expectedSemVer = '1.x';
                            if (json.version && !semver.satisfies(json.version, '1.x')) {
                                var versionError = new Error(`Semantic version mismatch.\nExpected: ${expectedSemVer}\nSupplied: ${json.version}`);
                                notifyError(errorNotificationTitle, `Version mismatch: ${json.version} vs. ${expectedSemVer}`, versionError);
                                reject(versionError);
                            } else {
                                var schema = {
                                    type: "object",
                                    properties: {
                                        "version": {
                                            type: "string",
                                            required: true
                                        },
                                        "snapshots": {
                                            type: "array",
                                            required: true,
                                            items: {
                                                type: "object",
                                                properties: {
                                                    "title": {
                                                        type: "string",
                                                        required: true
                                                    },
                                                    "url": {
                                                        type: "string",
                                                        required: true,
                                                        format: "uri"
                                                    },
                                                    "url_short": {
                                                        type: "string",
                                                        required: true,
                                                        format: "uri"
                                                    },
                                                    "pdf": {
                                                        type: "string",
                                                        required: true,
                                                        format: "uri"
                                                    },
                                                    "sha256": {
                                                        type: "string",
                                                        required: true,
                                                        pattern: /^[0-9a-f]{64}$/
                                                    },
                                                    "authors": {
                                                        type: "array",
                                                        required: true,
                                                        items: {
                                                            type: "string"
                                                        }
                                                    },
                                                    "doi": {
                                                        type: "string",
                                                        required: true,
                                                        pattern: new RegExp('^(10[.][0-9]{4,}(?:[.][0-9]+)*/(?:(?![%"#? ])\\S)+)$')
                                                    }
                                                }
                                            }
                                        }
                                    }
                                };

                                validateJSON(json, schema, {
                                    throwError: true
                                });

                                if (_.isEqual(json.snapshots, miscConfig.snapshots.articles)) {
                                    notifySuccess(successNotificationTitle, "No change detected.", json);
                                    resolve();
                                } else {
                                    settings.set("snapshots.articles", json.snapshots, {
                                            prettify: true
                                        });
                                    notifySuccess(successNotificationTitle, "Reloading …", json)
                                        .then(resolve)
                                        .then(() => location.reload());
                                }
                            }
                        } catch (jsonErr) {
                            notifyError(errorNotificationTitle, "The downloaded list is invalid.", jsonErr);
                            reject(jsonErr);
                        }
                    }
                });
            });
        }

        var recipientName = '';
        var recipientAddress = '';

        function switchToMailMode(which) {
            mode = "mail";
            bootbox.confirm({
                title: 'Please enter your email address',
                message: '<p>Select one of the input fields to open the on screen keyboard. Click outside the on screen keyboard to hide it.</p><br /><p><div class="form-group"><label for="emailName">Name:</label><input type="text" class="keyboard form-control" id="emailName"></div><div class="form-group"><label for="emailAddress">Email:</label><input type="text" class="keyboard form-control" id="emailAddress"></div></p>',
                callback: function(result) {
                    if (result) {
                        recipientName = $('#emailName').val().trim();
                        recipientAddress = $('#emailAddress').val().trim();
                        email(which);
                        recipientName = '';
                        recipientAddress = '';
                    }
                    switchToSlider();
                }
            });
            $("#emailName").keyboard();
            $("#emailAddress").keyboard();
        }

        function switchToPrintMode(snapshot) {
            mode = "print";
            bootbox.confirm({
                title: 'Confirm printing',
                message: `<p class="dialog">Do you want to print: <em>"<b>${snapshot.metadata.authors.map(a => a.trim()).join(", ")}:</b> ${snapshot.metadata.title.trim()}"</em>?<p>`,
                callback: result => {
                    if (result)
                        print(snapshot);
                    switchToSlider();
                }
            });
        }

        function print(snapshot) {
            return SnapshotPrinter.print(snapshot.cachedPdf)
                .then(() => notifySuccess('File has been sent to the printer'))
                .catch(error => notifyError('Print job failed', 'Please check the error message', error));
        }

        function email(which) {
            var c = articles[which];

            console.log('mailing ' + c.url + ' to ' + recipientAddress);

            const substUrls = function(s) {
                return format(s, {
                    websiteUrl: c.url,
                    pdfUrl: c.pdf,
                    defaultRecipientName: recipientName != '' ? recipientName : mailConfig.defaultRecipientName
                });
            };

            var formattedHtml = substUrls(mailConfig.html);
            var formattedText = typeof mailConfig.text !== 'undefined' && mailConfig.text != null ? substUrls(mailConfig.text) : htmlToText.fromString(formattedHtml, {
                hideLinkHrefIfSameAsText: true
            });

            // setup e-mail data with unicode symbols
            var mailOptions = {
                from: {
                    name: mailConfig.senderName,
                    address: mailConfig.senderAddress
                }, // sender address
                to: recipientName == '' ? recipientAddress : {
                    name: recipientName,
                    address: recipientAddress
                }, // list of receivers
                subject: mailConfig.subject, // subject line
                text: formattedText, // plaintext body
                html: formattedHtml, // html body
            };

            // send mail with defined transport object
            transporter.sendMail(mailOptions, function(error, info) {
                if (error) {
                    notifyError('Email could not be sent', 'Please check the error message', error);
                } else {
                    notifySuccess('Email sent successfully', "", info);
                }
            });
        }

        // GO!
        new Promise((resolve, reject) => $(document).ready(resolve))
            .then(miscConfig.snapshots.autoUpdate.enable ? () => {
                notifyInfo("Starting update of SNAPSHOT list");
                return updateSnapshotList().reflect();
            } : Promise.resolve())
            .then(initInitNotification)
            .then(() => {
                var startTime = performance.now()
                rearrangeConfig();
                updateProgressBar("#progressCache", {
                    max: articles.length
                });
                updateProgressBar("#progressDocs", {
                    max: articles.length
                });
                initTopLevelSlides();
                initSliders();
                var cachePDFPromises = [];
                var initDocumentPromises = [];
                var initNestedSlidesPromises = [];
                var initCompletePromises = [];
                snapshots = articles.map(article => new SNAPSHOT(article,{
                        cacheDir: cacheDir,
                        defaultWidth: 717,
                        defaultHeight: 1014
                    }));
                let totalNumPages = 0;
                snapshots.forEach( (snapshot, which) => {
                    let article = snapshot.metadata;

                    let cachePromise = snapshot.cacheDocumentPromise.catch(e => {
                        notifyError("Initialization error", `Could not cache "${article.authors.join(", ")}: ${article.title}" (doi: ${article.doi})`, e);
                        throw e;
                    });
                    let initDocumentPromise = snapshot.initDocumentPromise.catch(e => {
                        notifyError("Initialization error", `Failed to load "${article.authors.join(", ")}: ${article.title}" (doi: ${article.doi})`, e);
                        throw e;
                    });
                    let cachePagePromises = snapshot.cachePagePromises.catch(e => {
                        notifyError("Initialization error",
                            `Failed to render pages of "${article.authors.join(", ")}: ${article.title}" (doi: ${article.doi})`, e);
                        throw e;
                    });

                    cachePromise.finally(() => updateProgressBar("#progressCache", {
                        now: 1,
                        offset: true
                    }));
                    cachePagePromises.finally(() =>
                        updateProgressBar("#progressDocs", {
                            now: 1,
                            offset: true
                        })
                    );

                    initDocumentPromise = initDocumentPromise.then( document => {
                        totalNumPages += document.numPages;
                        updateProgressBar("#progressPages", {
                            max: totalNumPages
                        });
                        updateProgressBar("#progressRendered", {
                            max: totalNumPages
                        });
                        return document;
                    });

                    let initCompletePromise = cachePagePromises
                        .catch(e => {
                            disableSnapshot(which);
                            console.log("Problem processing snapshot", snapshot.metadata, e);
                        })
                        .then(actualCachePagePromises => Promise.all(actualCachePagePromises));

                    initDocumentPromise = initDocumentPromise.then(
                        document => { initNestedSlides(nestedSwipers[which],snapshot); return document; }
                    );

                    snapshot.initPagePromises.then( promises => promises.forEach( promise => promise.then(
                        () => updateProgressBar("#progressPages", {
                            now: 1,
                            offset: true
                        }))));

                    snapshot.cachePagePromises.then( promises => promises.forEach( promise => promise.then(
                        () => updateProgressBar("#progressRendered", {
                            now: 1,
                            offset: true
                        }))));

                    cachePDFPromises.push(cachePromise);
                    initDocumentPromises.push(initDocumentPromise);
                    initNestedSlidesPromises.push(cachePagePromises);
                    initCompletePromises.push(initCompletePromise);
                });

                Promise.all(initNestedSlidesPromises).catch(() => notifyWarning("Initialization incomplete", "Some SNAPSHOTS will be unavailable."));
                Promise.all(initCompletePromises)
                    .then(() => initNotification.close())
                    .then(() => {
                        initComplete = true;
                        window.requestAnimationFrame(swiper.params.slideReassignCallback);
                        //$('#progress').hide();
                        initIdleHandlers();
                        switchToSlider();
                        console.log(`loading took ${(performance.now()-startTime)/1000.0}s`)
                    });
            });
    </script>
</body>

</html>
